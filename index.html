<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inspeção de Cana</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --color-primary: #2e7d32;
      --color-primary-dark: #1b5e20;
      --color-accent: #4caf50;
      --color-bg: #f5f5f5;
      --color-text: #333333;
      --color-text-light: #555555;
      --color-white: #ffffff;
      --color-border: #e0e0e0;
      --color-danger: #d32f2f;
      --color-success: #388e3c;
      --color-warning: #f57c00;
      --color-purple: #7b1fa2;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      background-color: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    #loginScreen {
      flex: 1;
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(76, 175, 80, 0.2) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(46, 125, 50, 0.2) 0%, transparent 20%),
        linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    }
    
    #loginBox {
      background: var(--color-white);
      box-shadow: var(--shadow-xl);
      border-radius: var(--border-radius-xl);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      animation: fadeIn 0.5s ease-out;
      position: relative;
      overflow: hidden;
    }
    
    #loginBox::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to right, var(--color-primary), var(--color-accent));
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #loginBox h2 {
      margin-bottom: 24px;
      color: var(--color-primary);
      font-weight: 600;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
      position: relative;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--color-text-light);
      font-size: 14px;
      transition: var(--transition);
    }

    #loginBox input {
      width: 100%;
      padding: 14px 16px;
      border-radius: var(--border-radius);
      border: 1px solid var(--color-border);
      font-size: 16px;
      outline: none;
      transition: var(--transition);
      background-color: #f8fafc;
      box-shadow: var(--shadow-sm);
    }
    
    #loginBox input:focus {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
      background-color: var(--color-white);
    }
    
    #btnLogin {
      margin-top: 24px;
      width: 100%;
      padding: 16px;
      background: linear-gradient(to right, var(--color-primary), var(--color-accent));
      color: var(--color-white);
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    #btnLogin::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      transform: translateX(-100%);
      transition: var(--transition);
    }
    
    #btnLogin:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    #btnLogin:hover::after {
      transform: translateX(0);
    }
    
    #btnLogin i {
      font-size: 18px;
    }

    #loginMessage {
      color: var(--color-danger);
      min-height: 20px;
      margin-top: 16px;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
      color: var(--color-white);
      display: flex;
      align-items: center;
      padding: 0 24px;
      box-shadow: var(--shadow-md);
      z-index: 1000;
      user-select: none;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    header h1 {
      margin: 0;
      font-weight: 600;
      font-size: 20px;
      flex-grow: 1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .menu-toggle {
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      width: 48px;
      height: 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
      z-index: 1100;
      transition: var(--transition);
    }
    
    .menu-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .menu-toggle div {
      height: 3px;
      width: 24px;
      background: var(--color-white);
      border-radius: 3px;
      transition: var(--transition);
    }
    
    .menu-toggle.open div:nth-child(1) {
      transform: translateY(9px) rotate(45deg);
    }
    
    .menu-toggle.open div:nth-child(2) {
      opacity: 0;
    }
    
    .menu-toggle.open div:nth-child(3) {
      transform: translateY(-9px) rotate(-45deg);
    }

    nav.menu {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 280px;
      background: linear-gradient(to bottom, var(--color-primary), var(--color-primary-dark));
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 999;
      padding: 20px 0;
      visibility: hidden;
      box-shadow: var(--shadow-lg);
      border-top-right-radius: var(--border-radius-lg);
      border-bottom-right-radius: var(--border-radius-lg);
    }

    nav.menu.open {
      transform: translateX(0);
      visibility: visible;
    }

    .menu-btn, .excluir-btn {
      display: flex;
      align-items: center;
      gap: 16px;
      width: calc(100% - 20px);
      margin: 0 10px;
      padding: 16px 20px;
      background: transparent;
      border: none;
      font-weight: 500;
      color: rgba(255,255,255,0.9);
      cursor: pointer;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: var(--transition);
      text-align: left;
      position: relative;
    }
    
    .menu-btn::after, .excluir-btn::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20px;
      right: 20px;
      height: 1px;
      background: rgba(255,255,255,0.1);
    }
    
    .menu-btn:hover, .excluir-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--color-white);
    }
    
    .menu-btn.active, .excluir-btn.active {
      background: rgba(255,255,255,0.2);
      color: var(--color-white);
    }
    
    .menu-btn i {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }
    
    .excluir-btn {
      color: rgba(255,255,255,0.7);
    }
    
    .excluir-btn:hover {
      color: var(--color-white);
    }

    .menu-btn .arrow {
      margin-left: auto;
      transition: transform 0.3s ease;
      font-size: 14px;
    }
    
    .menu-btn.active .arrow {
      transform: rotate(90deg);
    }

    nav.submenu {
      position: fixed;
      top: 70px;
      left: 280px;
      width: 240px;
      bottom: 0;
      background: var(--color-white);
      box-shadow: var(--shadow-md);
      overflow-y: auto;
      z-index: 998;
      padding: 20px 0;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease-out;
      border-radius: 0 var(--border-radius-lg) var(--border-radius-lg) 0;
    }
    
    nav.submenu.open {
      visibility: visible;
      opacity: 1;
      transform: translateX(0);
    }

    nav.submenu button {
      width: 100%;
      padding: 14px 24px;
      background: none;
      border: none;
      text-align: left;
      font-size: 15px;
      cursor: pointer;
      font-weight: 500;
      color: var(--color-text-light);
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
    }
    
    nav.submenu button::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 24px;
      right: 24px;
      height: 1px;
      background: var(--color-border);
    }
    
    nav.submenu button i {
      font-size: 16px;
      width: 20px;
      color: var(--color-accent);
    }

    nav.submenu button:hover {
      background-color: #f0f4f8;
      color: var(--color-primary);
    }

    main.content {
      margin-top: 70px;
      padding: 30px;
      transition: margin-left 0.3s ease;
      min-height: calc(100vh - 70px);
    }

    main.content.menu-open {
      margin-left: 520px;
    }
    
    @media (max-width: 1200px) {
      main.content.menu-open {
        margin-left: 280px;
      }
      
      nav.submenu {
        left: 280px;
      }
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: var(--color-white);
      padding: 32px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-sm);
      font-size: 16px;
      max-width: 1000px;
      margin: 0 auto 30px;
      border-left: 4px solid var(--color-accent);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--color-accent);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .card h2 {
      color: var(--color-primary);
      margin-bottom: 24px;
      font-weight: 600;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }
    
    .card h2 i {
      color: var(--color-accent);
    }

    label {
      display: block;
      margin-top: 20px;
      font-weight: 500;
      color: var(--color-text-light);
      font-size: 14px;
    }
    
    label.required::after {
      content: " *";
      color: var(--color-danger);
    }

    input, select {
      width: 100%;
      padding: 14px 16px;
      margin-top: 8px;
      border-radius: var(--border-radius);
      border: 1px solid var(--color-border);
      font-size: 16px;
      transition: var(--transition);
      background-color: #f8fafc;
      box-shadow: var(--shadow-sm);
    }
    
    input:focus, select:focus {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
      outline: none;
      background-color: var(--color-white);
    }
    
    input[type="number"]:placeholder-shown {
      color: transparent;
    }

    input[type="number"]:focus:placeholder-shown {
      color: inherit;
    }
    
    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }
    
    .form-col {
      flex: 1;
    }

    button.save {
      margin-top: 32px;
      background: linear-gradient(to right, var(--color-primary), var(--color-accent));
      color: var(--color-white);
      border: none;
      padding: 16px 24px;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      max-width: 300px;
      position: relative;
      overflow: hidden;
    }
    
    button.save::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      transform: translateX(-100%);
      transition: var(--transition);
    }
    
    button.save:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    button.save:hover::after {
      transform: translateX(0);
    }
    
    button.save i {
      font-size: 18px;
    }

    .resultado {
      margin-top: 24px;
      font-weight: 600;
      color: var(--color-primary);
      font-size: 18px;
      padding: 12px 16px;
      background-color: #ebf8ff;
      border-radius: var(--border-radius);
      border-left: 4px solid var(--color-accent);
    }

    .botoes-relatorio {
      margin-top: 32px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .botoes-relatorio button {
      flex: 1;
      min-width: 200px;
      padding: 16px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      border-radius: var(--border-radius);
      background: linear-gradient(to right, var(--color-primary), var(--color-accent));
      color: var(--color-white);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .botoes-relatorio button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .botoes-relatorio button i {
      font-size: 18px;
    }

    .btn-excluir {
      padding: 8px 16px;
      margin-left: 10px;
      border-radius: var(--border-radius);
      border: none;
      background-color: var(--color-danger);
      color: var(--color-white);
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-excluir:hover {
      background-color: #c53030;
      transform: translateY(-1px);
    }
    
    .btn-excluir i {
      margin-right: 6px;
    }

    #alertContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: var(--color-success);
      color: #fff;
      padding: 16px 24px;
      border-radius: var(--border-radius);
      font-weight: 500;
      font-size: 15px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s ease;
      transform: translateY(-20px);
      z-index: 1500;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow-xl);
      max-width: 400px;
    }
    
    #alertContainer.error {
      background-color: var(--color-danger);
    }
    
    #alertContainer.warning {
      background-color: var(--color-warning);
    }

    #alertContainer.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    
    #alertContainer i {
      font-size: 20px;
    }

    #logoutInfo {
      position: absolute;
      top: 15px;
      right: 20px;
      background: rgba(255,255,255,0.9);
      color: var(--color-primary);
      padding: 8px 16px;
      border-radius: var(--border-radius);
      font-weight: 500;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      z-index: 1200;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    
    #logoutInfo > span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    
    #logoutBtn {
      background: var(--color-danger);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    
    #logoutBtn:hover {
      background: #c53030;
      transform: translateY(-1px);
    }
    
    #logoutBtn i {
      font-size: 14px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 40px;
    }

    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      font-weight: 500;
      color: var(--color-primary);
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-top: 30px;
    }

    .permission-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .permission-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #edf2f7;
      border-radius: var(--border-radius);
      font-size: 14px;
    }

    .permission-item i {
      color: var(--color-accent);
    }

    .user-role-badge {
      font-size: 12px;
      background: var(--color-primary);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }

    .user-status {
      font-size: 13px;
      color: var(--color-success);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .user-status.inactive {
      color: var(--color-danger);
    }

    .user-status i {
      font-size: 8px;
    }

    .user-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .user-card {
      padding: 15px;
      border-bottom: 1px solid var(--color-border);
      transition: var(--transition);
      border-radius: var(--border-radius);
    }

    .user-card:hover {
      background: #f8fafc;
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-title {
      font-weight: 500;
    }

    @media (max-width: 992px) {
      main.content.menu-open {
        margin-left: 280px;
      }
      
      nav.submenu {
        left: 280px;
        width: 220px;
      }

      .chart-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      nav.menu,
      nav.submenu {
        width: 100%;
        max-width: 280px;
      }
      
      main.content.menu-open {
        margin-left: 0;
        padding: 20px;
      }
      
      .card {
        padding: 24px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      header h1 {
        font-size: 18px;
        max-width: 50%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      #logoutInfo {
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
        padding: 6px 10px;
      }
      
      #logoutInfo > span {
        font-size: 12px;
      }
      
      #logoutBtn {
        padding: 4px 8px;
        font-size: 12px;
      }
    }

    @media (max-width: 576px) {
      #loginBox {
        padding: 30px 20px;
      }
      
      .botoes-relatorio button {
        min-width: 100%;
      }
      
      button.save {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div id="loginBox" role="main" aria-label="Tela de login">
      <h2><i class="fas fa-sign-in-alt"></i> BEM VINDO</h2>
      <div class="input-group">
        <label for="loginUser">Usuário</label>
        <input id="loginUser" placeholder="Digite seu usuário" aria-label="Campo usuário" />
      </div>
      <div class="input-group">
        <label for="loginPass">Senha</label>
        <input id="loginPass" type="password" placeholder="Digite sua senha" aria-label="Campo senha" />
      </div>
      <button id="btnLogin" aria-label="Botão de login"><i class="fas fa-sign-in-alt"></i> LOGIN</button>
      <div id="loginMessage" role="alert" aria-live="assertive"></div>
    </div>
  </div>

  <div id="appScreen" style="display:none; flex:1; flex-direction: column;">

    <header>
      <button class="menu-toggle" id="btnToggleMenu" aria-label="Abrir menu" aria-expanded="false" aria-controls="menu">
        <div></div><div></div><div></div>
      </button>
      <h1><i class="fas fa-search"></i> Inspeção de Cana</h1>
      <div id="logoutInfo" style="display:none;" role="region" aria-live="polite">
        <span id="userNameDisplay"></span>
        <span id="currentDateTime"></span>
        <button id="logoutBtn" aria-label="Botão sair do sistema"><i class="fas fa-sign-out-alt"></i> Sair</button>
      </div>
    </header>

    <nav class="menu" id="menu" aria-label="Menu Principal" tabindex="-1">
    </nav>

    <main class="content" id="content">
      <section id="dashboard" class="tab-content card" aria-label="Dashboard" tabindex="0" hidden>
        <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
        
        <div class="chart-grid">
          <div>
            <h3 class="chart-title">Média de Brocamento por Fazenda</h3>
            <div class="chart-container">
              <canvas id="graficoBrocamento" width="400" height="300"></canvas>
            </div>
          </div>
          <div>
            <h3 class="chart-title">Distribuição de Brocamento</h3>
            <div class="chart-container">
              <canvas id="graficoBrocamentoPizza" width="400" height="300"></canvas>
            </div>
          </div>
          <div>
            <h3 class="chart-title">Evolução de Brocamento</h3>
            <div class="chart-container">
              <canvas id="graficoBrocamentoLinha" width="400" height="300"></canvas>
            </div>
          </div>
          <div>
            <h3 class="chart-title">Média de Perda por Fazenda</h3>
            <div class="chart-container">
              <canvas id="graficoPerda" width="400" height="300"></canvas>
            </div>
          </div>
          <div>
            <h3 class="chart-title">Tipos de Perda</h3>
            <div class="chart-container">
              <canvas id="graficoPerdaRadar" width="400" height="300"></canvas>
            </div>
          </div>
          <div>
            <h3 class="chart-title">Evolução de Perda</h3>
            <div class="chart-container">
              <canvas id="graficoPerdaLinha" width="400" height="300"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="lancamentoBroca" class="tab-content card" aria-label="Lançamento Broca" tabindex="0" hidden>
        <h2><i class="fas fa-bug"></i> Lançamento Broca</h2>
        <div class="form-row">
          <div class="form-col">
            <label for="codigo" class="required">Código da Fazenda:</label>
            <input type="number" id="codigo" aria-describedby="fazendaNome" placeholder="Ex: 4012 para Faz. Lagoa Cercada" required />
            <div id="fazendaNome" aria-live="polite" style="font-weight:500; color: var(--color-primary); margin-top: 4px;"></div>
          </div>
          <div class="form-col">
            <label for="data" class="required">Data da Inspeção:</label>
            <input type="date" id="data" required />
          </div>
        </div>
        
        <label for="talhao" class="required">Talhão:</label>
        <input type="text" id="talhao" placeholder="Ex: T12, T15-A" required />

        <div class="form-row">
          <div class="form-col">
            <label for="entrenos" class="required">Entrenós Contados:</label>
            <input type="number" id="entrenos" min="1" placeholder="0" required />
          </div>
          <div class="form-col">
            <label for="brocado" class="required">Quantidade de Brocado:</label>
            <input type="number" id="brocado" min="0" placeholder="0" required />
          </div>
        </div>

        <div class="resultado" id="resultado"></div>

        <button class="save" type="button" id="btnSalvarBrocamento"><i class="fas fa-save"></i> Salvar Inspeção</button>
      </section>

      <section id="relatorioBroca" class="tab-content card" aria-label="Relatório Broca" tabindex="0" hidden>
        <h2><i class="fas fa-chart-bar"></i> Relatório de Inspeção de Cana (Brocamento)</h2>
        <div class="form-row">
          <div class="form-col">
            <label for="fazendaFiltroBrocamento">Filtrar por Fazenda:</label>
            <select id="fazendaFiltroBrocamento">
              <option value="">Todas</option>
              <option value="4012">FAZ. LAGOA CERCADA</option>
              <option value="4010">FAZ. PAULO MINEIRO</option>
              <option value="4045">FAZ. MERINDO I</option>
            </select>
          </div>
          <div class="form-col">
            <label for="inicioBrocamento">Data Início:</label>
            <input type="date" id="inicioBrocamento" />
          </div>
          <div class="form-col">
            <label for="fimBrocamento">Data Fim:</label>
            <input type="date" id="fimBrocamento" />
          </div>
        </div>

        <div class="botoes-relatorio">
          <button id="btnPDFBrocamento" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
          <button id="btnExcelBrocamento" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
        </div>
      </section>

      <section id="lancamentoPerda" class="tab-content card" aria-label="Lançamento Perda" tabindex="0" hidden>
        <h2><i class="fas fa-trash-alt"></i> Lançamento Perda</h2>
        <div class="form-row">
          <div class="form-col">
            <label for="dataPerda" class="required">Data:</label>
            <input type="date" id="dataPerda" required />
          </div>
          <div class="form-col">
            <label for="codigoPerda" class="required">Código da Fazenda:</label>
            <input type="number" id="codigoPerda" aria-describedby="fazendaNomePerda" placeholder="Ex: 4012 para Faz. Lagoa Cercada" required />
            <div id="fazendaNomePerda" aria-live="polite" style="font-weight:500; color: var(--color-primary); margin-top: 4px;"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label for="talhaoPerda" class="required">Talhão:</label>
            <input type="text" id="talhaoPerda" placeholder="Ex: T12, T15-A" required />
          </div>
          <div class="form-col">
            <label for="frenteServico" class="required">Frente de Serviço:</label>
            <input type="text" id="frenteServico" placeholder="Ex: Frente 1" required />
          </div>
          <div class="form-col">
            <label for="turno" class="required">Turno:</label>
            <select id="turno" required>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label for="canaInteira">Cana Inteira:</label>
            <input type="number" id="canaInteira" min="0" placeholder="0" />
          </div>
          <div class="form-col">
            <label for="tolete">Tolete:</label>
            <input type="number" id="tolete" min="0" placeholder="0" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label for="toco">Toco:</label>
            <input type="number" id="toco" min="0" placeholder="0" />
          </div>
          <div class="form-col">
            <label for="ponta">Ponta:</label>
            <input type="number" id="ponta" min="0" placeholder="0" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label for="estilhaco">Estilhaço:</label>
            <input type="number" id="estilhaco" min="0" placeholder="0" />
          </div>
          <div class="form-col">
            <label for="pedaco">Pedaço:</label>
            <input type="number" id="pedaco" min="0" placeholder="0" />
          </div>
        </div>

        <div class="resultado" id="resultadoPerda"></div>

        <button class="save" type="button" id="btnSalvarPerda"><i class="fas fa-save"></i> Salvar Perda de Cana</button>
      </section>

      <section id="relatorioPerda" class="tab-content card" aria-label="Relatório Perda" tabindex="0" hidden>
        <h2><i class="fas fa-chart-pie"></i> Relatório de Perda de Cana</h2>
        <div class="form-row">
          <div class="form-col">
            <label for="fazendaFiltroPerda">Filtrar por Fazenda:</label>
            <select id="fazendaFiltroPerda">
              <option value="">Todas</option>
              <option value="4012">FAZ. LAGOA CERCADA</option>
              <option value="4010">FAZ. PAULO MINEIRO</option>
              <option value="4045">FAZ. MERINDO I</option>
            </select>
          </div>
          <div class="form-col">
            <label for="talhaoFiltroPerda">Filtrar por Talhão:</label>
            <input type="text" id="talhaoFiltroPerda" placeholder="Digite Talhão" />
          </div>
          <div class="form-col">
            <label for="turnoFiltroPerda">Filtrar por Turno:</label>
            <select id="turnoFiltroPerda">
              <option value="">Todos</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label for="frenteFiltroPerda">Filtrar por Frente de Serviço:</label>
            <input type="text" id="frenteFiltroPerda" placeholder="Digite Frente de Serviço" />
          </div>
          <div class="form-col">
            <label for="inicioPerda">Data Início:</label>
            <input type="date" id="inicioPerda" />
          </div>
          <div class="form-col">
            <label for="fimPerda">Data Fim:</label>
            <input type="date" id="fimPerda" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label for="tipoRelatorioPerda">Tipo de Relatório:</label>
            <select id="tipoRelatorioPerda">
              <option value="A">Modelo A - Resumido</option>
              <option value="B">Modelo B - Detalhado</option>
            </select>
          </div>
        </div>

        <div class="botoes-relatorio">
          <button id="btnPDFPerda" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
          <button id="btnExcelPerda" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
        </div>
      </section>

      <section id="excluirDados" class="tab-content card" aria-label="Excluir Lançamentos" tabindex="0" hidden>
        <h2><i class="fas fa-trash"></i> Excluir Lançamentos</h2>
        <p>Selecione um lançamento para excluir:</p>
        <div id="listaExclusao" tabindex="0"></div>
      </section>

      <section id="gerenciarUsuarios" class="tab-content card" aria-label="Gerenciar Usuários" tabindex="0" hidden>
        <h2><i class="fas fa-users-cog"></i> Gerenciar Usuários</h2>

        <h3><i class="fas fa-user-plus"></i> Criar Novo Usuário</h3>
        <div class="form-row">
          <div class="form-col">
            <label for="newUserUsername" class="required">Nome do Usuário:</label>
            <input id="newUserUsername" type="text" placeholder="Nome do usuário" required />
          </div>
          <div class="form-col">
            <label for="newUserPassword" class="required">Senha:</label>
            <input id="newUserPassword" type="password" placeholder="Senha" required />
          </div>
          <div class="form-col">
            <label for="newUserRole">Perfil:</label>
            <select id="newUserRole">
              <option value="user">Usuário</option>
              <option value="admin">Administrador</option>
              <option value="supervisor">Supervisor</option>
              <option value="tecnico">Técnico</option>
              <option value="colaborador">Colaborador</option>
            </select>
          </div>
        </div>

        <fieldset style="margin-top: 20px; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 15px;">
          <legend style="padding: 0 10px; font-weight: 500; color: var(--color-text-light);">Permissões</legend>
          <div class="permission-grid">
            <label class="permission-item"><input type="checkbox" id="permDashboard" checked /> <i class="fas fa-tachometer-alt"></i> Dashboard</label>
            <label class="permission-item"><input type="checkbox" id="permLancamento" /> <i class="fas fa-pen"></i> Lanç. Broca</label>
            <label class="permission-item"><input type="checkbox" id="permLancamentoPerda" /> <i class="fas fa-trash-alt"></i> Lanç. Perda</label>
            <label class="permission-item"><input type="checkbox" id="permRelatorio" /> <i class="fas fa-chart-bar"></i> Relatórios</label>
            <label class="permission-item"><input type="checkbox" id="permExcluir" /> <i class="fas fa-trash"></i> Excluir Dados</label>
            <label class="permission-item"><input type="checkbox" id="permGerenciarUsuarios" /> <i class="fas fa-users-cog"></i> Geren. Usuários</label>
            <label class="permission-item"><input type="checkbox" id="permConfiguracoes" /> <i class="fas fa-cog"></i> Configurações</label>
            <label class="permission-item"><input type="checkbox" id="permExportar" /> <i class="fas fa-file-export"></i> Exportar Dados</label>
            <label class="permission-item"><input type="checkbox" id="permVisualizar" checked /> <i class="fas fa-eye"></i> Visualizar Dados</label>
            <label class="permission-item"><input type="checkbox" id="permEditar" /> <i class="fas fa-edit"></i> Editar Dados</label>
          </div>
        </fieldset>

        <button class="save" id="btnCreateUser" style="max-width: 250px; margin-top: 25px;"><i class="fas fa-user-plus"></i> Criar Usuário</button>

        <h3 style="margin-top: 30px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-users"></i> Usuários Cadastrados</h3>
        <div id="usersList" style="margin-top: 15px; border: 1px solid var(--color-border); border-radius: var(--border-radius); overflow: hidden;">
        </div>
      </section>

      <section id="configFazendas" class="tab-content card" aria-label="Configurações de Fazendas" tabindex="0" hidden>
        <h2><i class="fas fa-tractor"></i> Gerenciar Fazendas</h2>
        <p>Configurações de fazendas estarão disponíveis aqui em breve.</p>
      </section>

      <section id="configTalhoes" class="tab-content card" aria-label="Configurações de Talhões" tabindex="0" hidden>
        <h2><i class="fas fa-map-marked-alt"></i> Gerenciar Talhões</h2>
        <p>Configurações de talhões estarão disponíveis aqui em breve.</p>
      </section>
    </main>

    <div id="alertContainer" role="alert" aria-live="assertive"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <script>
    const fazendas = {
      4012: "FAZ. LAGOA CERCADA",
      4010: "FAZ. PAULO MINEIRO", 
      4045: "FAZ. MERINDO I"
    };

    function initializeAdminUser() {
      const adminUser = {
        username: 'admin',
        password: 'admin123',
        role: 'admin',
        active: true,
        permissions: {
          dashboard: true,
          lancamentoBroca: true,
          lancamentoPerda: true,
          relatorio: true,
          excluir: true,
          gerenciarUsuarios: true,
          configuracoes: true,
          exportar: true,
          visualizar: true,
          editar: true
        }
      };
      
      const supervisorUser = {
        username: 'supervisor',
        password: 'super123',
        role: 'supervisor',
        active: true,
        permissions: {
          dashboard: true,
          lancamentoBroca: false,
          lancamentoPerda: false,
          relatorio: false,
          excluir: false,
          gerenciarUsuarios: false,
          configuracoes: false,
          exportar: false,
          visualizar: true,
          editar: false
        }
      };
      
      const tecnicoUser = {
        username: 'tecnico',
        password: 'tec123',
        role: 'tecnico',
        active: true,
        permissions: {
          dashboard: true,
          lancamentoBroca: false,
          lancamentoPerda: false,
          relatorio: false,
          excluir: false,
          gerenciarUsuarios: false,
          configuracoes: false,
          exportar: false,
          visualizar: true,
          editar: false
        }
      };
      
      const colaboradorUser = {
        username: 'colaborador',
        password: 'colab123',
        role: 'colaborador',
        active: true,
        permissions: {
          dashboard: true,
          lancamentoBroca: false,
          lancamentoPerda: false,
          relatorio: false,
          excluir: false,
          gerenciarUsuarios: false,
          configuracoes: false,
          exportar: false,
          visualizar: true,
          editar: false
        }
      };
      
      let users = JSON.parse(localStorage.getItem('users')) || [];
      
      users = users.filter(u => u.username !== 'admin');
      
      users.push(adminUser);
      
      const addUserIfNotExists = (user) => {
        if(!users.some(u => u.username === user.username)) {
          users.push(user);
        }
      };
      
      addUserIfNotExists(supervisorUser);
      addUserIfNotExists(tecnicoUser);
      addUserIfNotExists(colaboradorUser);
      
      localStorage.setItem('users', JSON.stringify(users));
      
      return users;
    }

    let users = initializeAdminUser();
    let registros = JSON.parse(localStorage.getItem('registros')) || [];
    let perdas = JSON.parse(localStorage.getItem('perdas')) || [];
    let currentUser = null;

    const loginScreen = document.getElementById('loginScreen');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const btnLogin = document.getElementById('btnLogin');
    const loginMessage = document.getElementById('loginMessage');

    const appScreen = document.getElementById('appScreen');
    const logoutInfo = document.getElementById('logoutInfo');
    const userNameDisplay = document.getElementById('userNameDisplay');
    const currentDateTime = document.getElementById('currentDateTime');
    const logoutBtn = document.getElementById('logoutBtn');

    const btnToggleMenu = document.getElementById('btnToggleMenu');
    const menu = document.getElementById('menu');

    const content = document.getElementById('content');

    const newUserUsername = document.getElementById('newUserUsername');
    const newUserPassword = document.getElementById('newUserPassword');
    const newUserRole = document.getElementById('newUserRole');
    const permDashboard = document.getElementById('permDashboard');
    const permLancamento = document.getElementById('permLancamento');
    const permLancamentoPerda = document.getElementById('permLancamentoPerda');
    const permRelatorio = document.getElementById('permRelatorio');
    const permExcluir = document.getElementById('permExcluir');
    const permGerenciarUsuarios = document.getElementById('permGerenciarUsuarios');
    const permConfiguracoes = document.getElementById('permConfiguracoes');
    const permExportar = document.getElementById('permExportar');
    const permVisualizar = document.getElementById('permVisualizar');
    const permEditar = document.getElementById('permEditar');
    const btnCreateUser = document.getElementById('btnCreateUser');
    const usersList = document.getElementById('usersList');

    function showAlert(message, type = 'success') {
      const alert = document.getElementById('alertContainer');
      alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                         type === 'error' ? 'exclamation-circle' : 
                         'info-circle'}"></i>
        ${message}
      `;
      
      alert.className = type === 'error' ? 'error' : 
                       type === 'warning' ? 'warning' : '';
      
      alert.classList.add('show');
      setTimeout(() => alert.classList.remove('show'), 3000);
    }

    function formatDateTime() {
      const now = new Date();
      return now.toLocaleString('pt-BR', { 
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function updateDateTime() {
      if(currentUser) {
        currentDateTime.textContent = formatDateTime();
      }
    }

    function validarCampos(ids) {
      let valido = true;
      ids.forEach(id => {
        const el = document.getElementById(id);
        if(!el.value.trim()) {
          el.style.borderColor = 'var(--color-danger)';
          el.focus();
          valido = false;
        } else {
          el.style.borderColor = 'var(--color-border)';
        }
      });
      return valido;
    }

    function renderMenu() {
      menu.innerHTML = '';

      const menuCategories = [
        {
          name: 'principal',
          items: []
        },
        {
          name: 'registros',
          items: []
        },
        {
          name: 'administrativo',
          items: []
        }
      ];

      if(currentUser.permissions.dashboard) {
        menuCategories[0].items.push({
          id: 'btnDashboard',
          label: 'Dashboard',
          icon: 'fas fa-tachometer-alt',
          submenu: null,
          target: 'dashboard'
        });
      }

      if(currentUser.permissions.lancamentoBroca) {
        menuCategories[1].items.push({
          id: 'btnBroca',
          label: 'Broca',
          icon: 'fas fa-bug',
          submenu: currentUser.permissions.relatorio ? 'submenuBroca' : null,
          hasSubmenu: currentUser.permissions.relatorio,
          target: 'lancamentoBroca'
        });
      }

      if(currentUser.permissions.lancamentoPerda) {
        menuCategories[1].items.push({
          id: 'btnPerda',
          label: 'Perda',
          icon: 'fas fa-trash-alt',
          submenu: currentUser.permissions.relatorio ? 'submenuPerda' : null,
          hasSubmenu: currentUser.permissions.relatorio,
          target: 'lancamentoPerda'
        });
      }

      if(currentUser.permissions.excluir) {
        menuCategories[1].items.push({
          id: 'btnExcluirDados',
          label: 'Excluir Dados',
          icon: 'fas fa-trash',
          submenu: null,
          excluirBtn: true,
          target: 'excluirDados'
        });
      }

      if(currentUser.permissions.gerenciarUsuarios) {
        menuCategories[2].items.push({
          id: 'btnGerenciarUsuarios',
          label: 'Usuários',
          icon: 'fas fa-users-cog',
          submenu: 'submenuUsuarios',
          hasSubmenu: true,
          target: 'gerenciarUsuarios'
        });
      }

      if(currentUser.permissions.configuracoes) {
        menuCategories[2].items.push({
          id: 'btnConfiguracoes',
          label: 'Configurações',
          icon: 'fas fa-cog',
          submenu: 'submenuConfiguracoes',
          hasSubmenu: true,
          target: 'configFazendas'
        });
      }

      menuCategories.forEach(category => {
        if(category.items.length > 0) {
          if(menu.children.length > 0) {
            const separator = document.createElement('div');
            separator.style.height = '1px';
            separator.style.background = 'rgba(255,255,255,0.1)';
            separator.style.margin = '10px 20px';
            menu.appendChild(separator);
          }

          category.items.forEach(item => {
            const btn = document.createElement('button');
            btn.className = item.excluirBtn ? 'excluir-btn' : 'menu-btn';
            btn.id = item.id;
            btn.type = 'button';
            btn.setAttribute('aria-haspopup', item.submenu ? 'true' : 'false');
            btn.setAttribute('aria-controls', item.submenu || '');
            btn.setAttribute('aria-expanded', 'false');
            btn.setAttribute('aria-label', item.label);
            
            const icon = document.createElement('i');
            icon.className = item.icon;
            btn.appendChild(icon);
            
            const text = document.createElement('span');
            text.textContent = item.label;
            btn.appendChild(text);
            
            if(item.submenu) {
              const arrow = document.createElement('span');
              arrow.className = 'arrow';
              arrow.innerHTML = '&rsaquo;';
              btn.appendChild(arrow);
            }

            menu.appendChild(btn);

            btn.addEventListener('click', (e) => {
              if(item.submenu) {
                e.stopPropagation();
                toggleSubmenu(btn, item.submenu);
              } else {
                closeAllMenus();
                hideAllTabs();
                showTab(item.target || 'dashboard');
                
                if(item.target === 'dashboard') {
                  renderGraficoBrocamento();
                  renderGraficoPerda();
                }
                
                if(item.target === 'excluirDados') {
                  renderExclusao();
                }
                
                if(item.target === 'gerenciarUsuarios') {
                  renderUsersList();
                }
              }
            });
          });
        }
      });

      createSubmenus();
    }

    function createSubmenus() {
      document.querySelectorAll('nav.submenu').forEach(el => el.remove());

      if(currentUser.permissions.lancamentoBroca && currentUser.permissions.relatorio) {
        const submenuBroca = document.createElement('nav');
        submenuBroca.className = 'submenu';
        submenuBroca.id = 'submenuBroca';
        submenuBroca.setAttribute('aria-label', 'Submenu Broca');
        submenuBroca.setAttribute('role', 'menu');
        submenuBroca.setAttribute('aria-hidden', 'true');
        submenuBroca.tabIndex = -1;
        
        const lancamentoBtn = document.createElement('button');
        lancamentoBtn.setAttribute('role', 'menuitem');
        lancamentoBtn.type = 'button';
        lancamentoBtn.dataset.target = 'lancamentoBroca';
        lancamentoBtn.innerHTML = '<i class="fas fa-pen"></i> Lançamento';
        submenuBroca.appendChild(lancamentoBtn);
        
        const relatorioBtn = document.createElement('button');
        relatorioBtn.setAttribute('role', 'menuitem');
        relatorioBtn.type = 'button';
        relatorioBtn.dataset.target = 'relatorioBroca';
        relatorioBtn.className = 'relatorio-btn';
        relatorioBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Relatório';
        submenuBroca.appendChild(relatorioBtn);
        
        document.body.appendChild(submenuBroca);
        
        setupSubmenuBehavior(submenuBroca);
      }

      if(currentUser.permissions.lancamentoPerda && currentUser.permissions.relatorio) {
        const submenuPerda = document.createElement('nav');
        submenuPerda.className = 'submenu';
        submenuPerda.id = 'submenuPerda';
        submenuPerda.setAttribute('aria-label', 'Submenu Perda');
        submenuPerda.setAttribute('role', 'menu');
        submenuPerda.setAttribute('aria-hidden', 'true');
        submenuPerda.tabIndex = -1;
        
        const lancamentoBtn = document.createElement('button');
        lancamentoBtn.setAttribute('role', 'menuitem');
        lancamentoBtn.type = 'button';
        lancamentoBtn.dataset.target = 'lancamentoPerda';
        lancamentoBtn.innerHTML = '<i class="fas fa-pen"></i> Lançamento';
        submenuPerda.appendChild(lancamentoBtn);
        
        const relatorioBtn = document.createElement('button');
        relatorioBtn.setAttribute('role', 'menuitem');
        relatorioBtn.type = 'button';
        relatorioBtn.dataset.target = 'relatorioPerda';
        relatorioBtn.className = 'relatorio-btn';
        relatorioBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Relatório';
        submenuPerda.appendChild(relatorioBtn);
        
        document.body.appendChild(submenuPerda);
        
        setupSubmenuBehavior(submenuPerda);
      }

      if(currentUser.permissions.gerenciarUsuarios) {
        const submenuUsuarios = document.createElement('nav');
        submenuUsuarios.className = 'submenu';
        submenuUsuarios.id = 'submenuUsuarios';
        submenuUsuarios.setAttribute('aria-label', 'Submenu Usuários');
        submenuUsuarios.setAttribute('role', 'menu');
        submenuUsuarios.setAttribute('aria-hidden', 'true');
        submenuUsuarios.tabIndex = -1;
        
        const gerenciarBtn = document.createElement('button');
        gerenciarBtn.setAttribute('role', 'menuitem');
        gerenciarBtn.type = 'button';
        gerenciarBtn.dataset.target = 'gerenciarUsuarios';
        gerenciarBtn.innerHTML = '<i class="fas fa-users-cog"></i> Gerenciar Usuários';
        submenuUsuarios.appendChild(gerenciarBtn);
        
        document.body.appendChild(submenuUsuarios);
        
        setupSubmenuBehavior(submenuUsuarios);
      }

      if(currentUser.permissions.configuracoes) {
        const submenuConfiguracoes = document.createElement('nav');
        submenuConfiguracoes.className = 'submenu';
        submenuConfiguracoes.id = 'submenuConfiguracoes';
        submenuConfiguracoes.setAttribute('aria-label', 'Submenu Configurações');
        submenuConfiguracoes.setAttribute('role', 'menu');
        submenuConfiguracoes.setAttribute('aria-hidden', 'true');
        submenuConfiguracoes.tabIndex = -1;
        
        const fazendasBtn = document.createElement('button');
        fazendasBtn.setAttribute('role', 'menuitem');
        fazendasBtn.type = 'button';
        fazendasBtn.dataset.target = 'configFazendas';
        fazendasBtn.innerHTML = '<i class="fas fa-tractor"></i> Gerenciar Fazendas';
        submenuConfiguracoes.appendChild(fazendasBtn);
        
        const talhoesBtn = document.createElement('button');
        talhoesBtn.setAttribute('role', 'menuitem');
        talhoesBtn.type = 'button';
        talhoesBtn.dataset.target = 'configTalhoes';
        talhoesBtn.innerHTML = '<i class="fas fa-map-marked-alt"></i> Gerenciar Talhões';
        submenuConfiguracoes.appendChild(talhoesBtn);
        
        document.body.appendChild(submenuConfiguracoes);
        
        setupSubmenuBehavior(submenuConfiguracoes);
      }
    }

    function setupSubmenuBehavior(submenu) {
      submenu.addEventListener('click', e => {
        if(e.target.matches('button[data-target]')) {
          if(e.target.classList.contains('relatorio-btn') && !currentUser.permissions.relatorio) {
            showAlert("Você não tem permissão para acessar relatórios", "error");
            return;
          }
          closeAllMenus();
          showTab(e.target.dataset.target);
          
          btnToggleMenu.classList.remove('open');
          menu.classList.remove('open');
          content.classList.remove('menu-open');
        }
      });
    }

    function toggleSubmenu(button, submenuId) {
      const isOpen = button.getAttribute('aria-expanded') === 'true';
      closeAllMenus();
      hideAllTabs();
      
      if(!isOpen) {
        button.setAttribute('aria-expanded', 'true');
        button.classList.add('active');
        
        const submenu = document.getElementById(submenuId);
        if(submenu) {
          submenu.classList.add('open');
          submenu.setAttribute('aria-hidden', 'false');
          submenu.style.visibility = 'visible';
          submenu.style.opacity = '1';
          submenu.focus();
        }
      }
    }

    function closeAllMenus() {
      document.querySelectorAll('.menu-btn, .excluir-btn').forEach(btn => {
        btn.setAttribute('aria-expanded', 'false');
        btn.classList.remove('active');
      });
      
      document.querySelectorAll('nav.submenu').forEach(menu => {
        menu.classList.remove('open');
        menu.setAttribute('aria-hidden', 'true');
        menu.style.visibility = 'hidden';
        menu.style.opacity = '0';
      });
    }

    function hideAllTabs() {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
        tab.hidden = true;
      });
    }

    function showTab(id) {
      if(!id) return;
      hideAllTabs();
      const el = document.getElementById(id);
      if(el) {
        el.classList.add('active');
        el.hidden = false;
        el.focus();
      }
    }

    function renderGraficoBrocamento() {
      const ctx = document.getElementById('graficoBrocamento').getContext('2d');
      
      const dadosPorFazenda = {};
      registros.forEach(reg => {
        if(!dadosPorFazenda[reg.fazenda]) {
          dadosPorFazenda[reg.fazenda] = [];
        }
        dadosPorFazenda[reg.fazenda].push(parseFloat(reg.brocamento.replace(',', '.')));
      });
      
      const labels = Object.keys(dadosPorFazenda);
      const dados = labels.map(fazenda => {
        const valores = dadosPorFazenda[fazenda];
        const soma = valores.reduce((a, b) => a + b, 0);
        return (soma / valores.length).toFixed(2);
      });
      
      if(window.brocamentoChart) {
        window.brocamentoChart.destroy();
      }
      
      window.brocamentoChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Média de Brocamento (%)',
            data: dados,
            backgroundColor: '#4caf50',
            borderColor: '#2e7d32',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.raw + '%';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Porcentagem de Brocamento'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Fazenda'
              }
            }
          }
        }
      });

      const ctxPizza = document.getElementById('graficoBrocamentoPizza').getContext('2d');
      
      if(window.brocamentoPizzaChart) {
        window.brocamentoPizzaChart.destroy();
      }
      
      window.brocamentoPizzaChart = new Chart(ctxPizza, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: dados,
            backgroundColor: [
              '#4caf50',
              '#2e7d32',
              '#388e3c',
              '#66bb6a'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + context.raw + '%';
                }
              }
            },
            datalabels: {
              formatter: (value) => {
                return value + '%';
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      const ctxLinha = document.getElementById('graficoBrocamentoLinha').getContext('2d');
      
      const dadosPorData = {};
      registros.forEach(reg => {
        if(!dadosPorData[reg.data]) {
          dadosPorData[reg.data] = [];
        }
        dadosPorData[reg.data].push(parseFloat(reg.brocamento.replace(',', '.')));
      });
      
      const datas = Object.keys(dadosPorData).sort();
      const mediasPorData = datas.map(data => {
        const valores = dadosPorData[data];
        const soma = valores.reduce((a, b) => a + b, 0);
        return (soma / valores.length).toFixed(2);
      });
      
      if(window.brocamentoLinhaChart) {
        window.brocamentoLinhaChart.destroy();
      }
      
      window.brocamentoLinhaChart = new Chart(ctxLinha, {
        type: 'line',
        data: {
          labels: datas,
          datasets: [{
            label: 'Média de Brocamento (%)',
            data: mediasPorData,
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: '#4caf50',
            borderWidth: 2,
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.raw + '%';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Porcentagem de Brocamento'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Data'
              }
            }
          }
        }
      });
    }

    function renderGraficoPerda() {
      const ctx = document.getElementById('graficoPerda').getContext('2d');
      
      const dadosPorFazenda = {};
      perdas.forEach(perda => {
        if(!dadosPorFazenda[perda.fazenda]) {
          dadosPorFazenda[perda.fazenda] = [];
        }
        dadosPorFazenda[perda.fazenda].push(parseFloat(perda.total));
      });
      
      const labels = Object.keys(dadosPorFazenda);
      const dados = labels.map(fazenda => {
        const valores = dadosPorFazenda[fazenda];
        const soma = valores.reduce((a, b) => a + b, 0);
        return (soma / valores.length).toFixed(2);
      });
      
      if(window.perdaChart) {
        window.perdaChart.destroy();
      }
      
      window.perdaChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Média de Perda (Total)',
            data: dados,
            backgroundColor: '#388e3c',
            borderColor: '#2e7d32',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.raw;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Total de Perda'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Fazenda'
              }
            }
          }
        }
      });

      const ctxRadar = document.getElementById('graficoPerdaRadar').getContext('2d');
      
      const tiposPerda = ['canaInteira', 'tolete', 'toco', 'ponta', 'estilhaco', 'pedaco'];
      const labelsPerda = ['Cana Inteira', 'Tolete', 'Toco', 'Ponta', 'Estilhaço', 'Pedaço'];
      const dadosPerda = tiposPerda.map(tipo => {
        return perdas.reduce((sum, perda) => sum + perda[tipo], 0);
      });
      
      if(window.perdaRadarChart) {
        window.perdaRadarChart.destroy();
      }
      
      window.perdaRadarChart = new Chart(ctxRadar, {
        type: 'radar',
        data: {
          labels: labelsPerda,
          datasets: [{
            label: 'Total por Tipo de Perda',
            data: dadosPerda,
            backgroundColor: 'rgba(56, 142, 60, 0.2)',
            borderColor: '#388e3c',
            borderWidth: 2,
            pointBackgroundColor: '#388e3c',
            pointBorderColor: '#fff',
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            r: {
              angleLines: {
                display: true
              },
              suggestedMin: 0
            }
          }
        }
      });

      const ctxLinha = document.getElementById('graficoPerdaLinha').getContext('2d');
      
      const dadosPorData = {};
      perdas.forEach(perda => {
        if(!dadosPorData[perda.data]) {
          dadosPorData[perda.data] = [];
        }
        dadosPorData[perda.data].push(parseFloat(perda.total));
      });
      
      const datas = Object.keys(dadosPorData).sort();
      const mediasPorData = datas.map(data => {
        const valores = dadosPorData[data];
        const soma = valores.reduce((a, b) => a + b, 0);
        return (soma / valores.length).toFixed(2);
      });
      
      if(window.perdaLinhaChart) {
        window.perdaLinhaChart.destroy();
      }
      
      window.perdaLinhaChart = new Chart(ctxLinha, {
        type: 'line',
        data: {
          labels: datas,
          datasets: [{
            label: 'Média de Perda (Total)',
            data: mediasPorData,
            backgroundColor: 'rgba(56, 142, 60, 0.2)',
            borderColor: '#388e3c',
            borderWidth: 2,
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.raw;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Total de Perda'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Data'
              }
            }
          }
        }
      });
    }

    function renderExclusao() {
      const container = document.getElementById('listaExclusao');
      container.innerHTML = '';
      
      if(registros.length === 0 && perdas.length === 0) {
        container.innerHTML = '<p>Nenhum lançamento encontrado.</p>';
        return;
      }
      
      if(registros.length > 0) {
        const h3 = document.createElement('h3');
        h3.textContent = 'Brocamento';
        h3.style.marginTop = '20px';
        h3.style.color = 'var(--color-primary)';
        container.appendChild(h3);
        
        registros.forEach((reg, index) => {
          const div = document.createElement('div');
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.style.padding = '10px';
          div.style.borderBottom = '1px solid var(--color-border)';
          div.style.borderRadius = 'var(--border-radius)';
          
          const info = document.createElement('div');
          info.innerHTML = `
            <strong>${reg.fazenda}</strong> - ${reg.talhao}<br>
            <small>${reg.data} - ${reg.brocamento}%</small>
          `;
          
          const btn = document.createElement('button');
          btn.className = 'btn-excluir';
          btn.innerHTML = '<i class="fas fa-trash"></i> Excluir';
          btn.onclick = () => excluirRegistro('brocamento', index);
          
          div.appendChild(info);
          div.appendChild(btn);
          container.appendChild(div);
        });
      }
      
      if(perdas.length > 0) {
        const h3 = document.createElement('h3');
        h3.textContent = 'Perda de Cana';
        h3.style.marginTop = '20px';
        h3.style.color = 'var(--color-primary)';
        container.appendChild(h3);
        
        perdas.forEach((perda, index) => {
          const div = document.createElement('div');
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.style.padding = '10px';
          div.style.borderBottom = '1px solid var(--color-border)';
          div.style.borderRadius = 'var(--border-radius)';
          
          const info = document.createElement('div');
          info.innerHTML = `
            <strong>${perda.fazenda}</strong> - ${perda.talhao} (${perda.turno})<br>
            <small>${perda.data} - Total: ${perda.total}</small>
          `;
          
          const btn = document.createElement('button');
          btn.className = 'btn-excluir';
          btn.innerHTML = '<i class="fas fa-trash"></i> Excluir';
          btn.onclick = () => excluirRegistro('perda', index);
          
          div.appendChild(info);
          div.appendChild(btn);
          container.appendChild(div);
        });
      }
    }

    function excluirRegistro(tipo, index) {
      if(confirm('Tem certeza que deseja excluir este registro?')) {
        if(tipo === 'brocamento') {
          registros.splice(index, 1);
          localStorage.setItem('registros', JSON.stringify(registros));
          renderGraficoBrocamento();
        } else {
          perdas.splice(index, 1);
          localStorage.setItem('perdas', JSON.stringify(perdas));
          renderGraficoPerda();
        }
        renderExclusao();
        showAlert('Registro excluído com sucesso!');
      }
    }

    function renderUsersList() {
      usersList.innerHTML = '';
      
      if(users.length === 0) {
        usersList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--color-text-light);">Nenhum usuário cadastrado</div>';
        return;
      }
      
      users.forEach((u, i) => {
        const userDiv = document.createElement('div');
        userDiv.className = 'user-card';
        
        const userHeader = document.createElement('div');
        userHeader.className = 'user-header';
        
        const userTitle = document.createElement('div');
        userTitle.className = 'user-title';
        userTitle.innerHTML = `
          ${u.username} 
          <span class="user-role-badge" style="background: ${u.role === 'admin' ? 'var(--color-primary)' : 
                            u.role === 'supervisor' ? 'var(--color-warning)' :
                            u.role === 'tecnico' ? 'var(--color-accent)' :
                            u.role === 'colaborador' ? 'var(--color-purple)' :
                            '#718096'}">
            ${u.role === 'admin' ? 'Administrador' : 
             u.role === 'supervisor' ? 'Supervisor' :
             u.role === 'tecnico' ? 'Técnico' :
             u.role === 'colaborador' ? 'Colaborador' : 'Usuário'}
          </span>
        `;
        
        const userStatus = document.createElement('div');
        userStatus.className = `user-status ${u.active ? '' : 'inactive'}`;
        userStatus.innerHTML = `
          <i class="fas fa-circle"></i> 
          ${u.active ? 'Ativo' : 'Inativo'}
        `;
        
        userHeader.appendChild(userTitle);
        userHeader.appendChild(userStatus);
        userDiv.appendChild(userHeader);
        
        const permsDiv = document.createElement('div');
        permsDiv.style.display = 'flex';
        permsDiv.style.flexWrap = 'wrap';
        permsDiv.style.gap = '10px';
        permsDiv.style.marginTop = '10px';
        
        Object.entries(u.permissions).forEach(([key, val]) => {
          if(val) {
            const permSpan = document.createElement('span');
            permSpan.className = 'permission-item';
            permSpan.innerHTML = `
              <i class="fas fa-${getPermissionIcon(key)}"></i>
              ${getPermissionLabel(key)}
            `;
            permsDiv.appendChild(permSpan);
          }
        });
        
        userDiv.appendChild(permsDiv);
        
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'user-actions';
        
        if(currentUser.username !== u.username) {
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn-excluir';
          deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Excluir';
          deleteBtn.onclick = () => {
            if(confirm(`Tem certeza que deseja excluir o usuário ${u.username}?`)) {
              users.splice(i, 1);
              saveUsers();
              renderUsersList();
              showAlert(`Usuário ${u.username} excluído`, 'success');
            }
          };
          buttonsDiv.appendChild(deleteBtn);
        }
        
        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn-excluir';
        resetBtn.style.background = 'var(--color-warning)';
        resetBtn.innerHTML = '<i class="fas fa-key"></i> Resetar Senha';
        resetBtn.onclick = () => {
          users[i].password = 'novaSenha123';
          saveUsers();
          showAlert(`Senha de ${u.username} resetada para "novaSenha123"`, 'warning');
        };
        buttonsDiv.appendChild(resetBtn);
        
        if(currentUser.username !== u.username) {
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'btn-excluir';
          toggleBtn.style.background = u.active ? '#718096' : 'var(--color-success)';
          toggleBtn.innerHTML = u.active ? '<i class="fas fa-ban"></i> Desativar' : '<i class="fas fa-check"></i> Ativar';
          toggleBtn.onclick = () => {
            users[i].active = !users[i].active;
            saveUsers();
            renderUsersList();
            showAlert(`Usuário ${u.username} ${users[i].active ? 'ativado' : 'desativado'}`, 'success');
          };
          buttonsDiv.appendChild(toggleBtn);
        }
        
        userDiv.appendChild(buttonsDiv);
        usersList.appendChild(userDiv);
      });
    }

    function getPermissionIcon(key) {
      const icons = {
        dashboard: 'tachometer-alt',
        lancamentoBroca: 'pen',
        lancamentoPerda: 'trash-alt',
        relatorio: 'chart-bar',
        excluir: 'trash',
        gerenciarUsuarios: 'users-cog',
        configuracoes: 'cog',
        exportar: 'file-export',
        visualizar: 'eye',
        editar: 'edit'
      };
      return icons[key] || 'check-circle';
    }

    function getPermissionLabel(key) {
      const labels = {
        dashboard: 'Dashboard',
        lancamentoBroca: 'Lanç. Broca',
        lancamentoPerda: 'Lanç. Perda',
        relatorio: 'Relatórios',
        excluir: 'Excluir',
        gerenciarUsuarios: 'Geren. Usuários',
        configuracoes: 'Configurações',
        exportar: 'Exportar',
        visualizar: 'Visualizar',
        editar: 'Editar'
      };
      return labels[key] || key;
    }

    function saveUsers() {
      localStorage.setItem('users', JSON.stringify(users));
    }

    function updateFazendaNome(idInput, idOutput) {
      const val = document.getElementById(idInput).value.trim();
      const nome = fazendas[val];
      document.getElementById(idOutput).textContent = nome ? `Fazenda: ${nome}` : '';
    }

    function calcularPorcentagemBrocamento() {
      const entrenos = parseInt(document.getElementById('entrenos').value);
      const brocado = parseInt(document.getElementById('brocado').value);
      const resultado = document.getElementById('resultado');

      if (!isNaN(entrenos) && !isNaN(brocado) && entrenos > 0) {
        const porcentagem = (brocado / entrenos) * 100;
        resultado.textContent = `Brocamento: ${porcentagem.toFixed(2).replace('.', ',')}%`;
        resultado.style.color = porcentagem > 20 ? 'var(--color-danger)' : 'var(--color-success)';
      } else {
        resultado.textContent = '';
      }
    }

    function calcularSomaPerda() {
      const campos = ['canaInteira', 'tolete', 'toco', 'ponta', 'estilhaco', 'pedaco'];
      let soma = 0;
      campos.forEach(id => {
        let val = parseFloat(document.getElementById(id).value);
        if (isNaN(val)) val = 0;
        soma += val;
      });
      document.getElementById('resultadoPerda').textContent = `Total Perda: ${soma.toFixed(2).replace('.', ',')}`;
    }

    function salvarBrocamento() {
      const camposObrigatorios = ['codigo', 'data', 'talhao', 'entrenos', 'brocado'];
      if(!validarCampos(camposObrigatorios)) {
        showAlert("Preencha todos os campos obrigatórios!", "error");
        return;
      }
      
      const btn = document.getElementById('btnSalvarBrocamento');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      btn.disabled = true;
      
      try {
        const entrenos = parseInt(document.getElementById('entrenos').value);
        const brocado = parseInt(document.getElementById('brocado').value);

        if (isNaN(entrenos) || entrenos <= 0 || isNaN(brocado)) {
          throw new Error('Preencha corretamente os campos de entrenos e brocado.');
        }

        const porcentagem = (brocado / entrenos) * 100;

        registros.push({
          codigo: document.getElementById('codigo').value.trim(),
          fazenda: fazendas[document.getElementById('codigo').value.trim()],
          data: document.getElementById('data').value,
          talhao: document.getElementById('talhao').value.trim(),
          entrenos,
          brocado,
          brocamento: porcentagem.toFixed(2).replace('.', ','),
          usuario: currentUser.username
        });

        localStorage.setItem('registros', JSON.stringify(registros));
        showAlert('Inspeção salva com sucesso!', 'success');

        ['codigo','data','talhao','entrenos','brocado'].forEach(id => {
          document.getElementById(id).value = '';
        });
        document.getElementById('fazendaNome').textContent = '';
        document.getElementById('resultado').textContent = '';
        document.getElementById('codigo').focus();

        renderGraficoBrocamento();
        
      } catch (error) {
        showAlert(error.message, 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    function salvarPerda() {
      const camposObrigatorios = ['dataPerda', 'codigoPerda', 'frenteServico', 'talhaoPerda'];
      if(!validarCampos(camposObrigatorios)) {
        showAlert("Preencha todos os campos obrigatórios!", "error");
        return;
      }
      
      const btn = document.getElementById('btnSalvarPerda');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      btn.disabled = true;
      
      try {
        const dataPerda = document.getElementById('dataPerda').value;
        const codigoPerda = document.getElementById('codigoPerda').value.trim();
        const frenteServico = document.getElementById('frenteServico').value.trim();
        const talhaoPerda = document.getElementById('talhaoPerda').value.trim();
        const turno = document.getElementById('turno').value;

        const canaInteira = parseFloat(document.getElementById('canaInteira').value) || 0;
        const tolete = parseFloat(document.getElementById('tolete').value) || 0;
        const toco = parseFloat(document.getElementById('toco').value) || 0;
        const ponta = parseFloat(document.getElementById('ponta').value) || 0;
        const estilhaco = parseFloat(document.getElementById('estilhaco').value) || 0;
        const pedaco = parseFloat(document.getElementById('pedaco').value) || 0;

        const total = canaInteira + tolete + toco + ponta + estilhaco + pedaco;
        const media = total / 6;

        perdas.push({
          data: dataPerda,
          codigo: codigoPerda,
          fazenda: fazendas[codigoPerda],
          frenteServico,
          turno,
          talhao: talhaoPerda,
          canaInteira,
          tolete,
          toco,
          ponta,
          estilhaco,
          pedaco,
          total,
          media: media.toFixed(2).replace('.', ','),
          usuario: currentUser.username
        });

        localStorage.setItem('perdas', JSON.stringify(perdas));
        showAlert('Perda de Cana salva com sucesso!', 'success');

        ['dataPerda','codigoPerda','frenteServico','talhaoPerda'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('fazendaNomePerda').textContent = '';
        ['canaInteira','tolete','toco','ponta','estilhaco','pedaco'].forEach(id => document.getElementById(id).value = '0');
        document.getElementById('turno').value = 'A';
        document.getElementById('resultadoPerda').textContent = '';
        document.getElementById('dataPerda').focus();

        renderGraficoPerda();
        
      } catch (error) {
        showAlert(error.message, 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    function gerarRelatorioBrocamentoPDF() {
      if(!currentUser.permissions.exportar) {
        showAlert("Você não tem permissão para exportar relatórios", "error");
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('Relatório de Brocamento', 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      const fazendaFiltro = document.getElementById('fazendaFiltroBrocamento').value;
      const inicio = document.getElementById('inicioBrocamento').value;
      const fim = document.getElementById('fimBrocamento').value;
      
      let filtros = 'Filtros: ';
      if(fazendaFiltro) filtros += `Fazenda: ${fazendas[fazendaFiltro] || fazendaFiltro} `;
      if(inicio) filtros += `De: ${inicio} `;
      if(fim) filtros += `Até: ${fim}`;
      
      doc.text(filtros, 14, 25);
      
      const headers = [['Fazenda', 'Talhão', 'Data', 'Entrenós', 'Brocado', 'Brocamento (%)']];
      
      let dadosFiltrados = [...registros];
      
      if(fazendaFiltro) {
        dadosFiltrados = dadosFiltrados.filter(reg => reg.codigo === fazendaFiltro);
      }
      
      if(inicio) {
        dadosFiltrados = dadosFiltrados.filter(reg => reg.data >= inicio);
      }
      
      if(fim) {
        dadosFiltrados = dadosFiltrados.filter(reg => reg.data <= fim);
      }
      
      const data = dadosFiltrados.map(reg => [
        reg.fazenda,
        reg.talhao,
        reg.data,
        reg.entrenos,
        reg.brocado,
        reg.brocamento
      ]);
      
      doc.autoTable({
        head: headers,
        body: data,
        startY: 30,
        styles: {
          fontSize: 10,
          cellPadding: 3,
          halign: 'center'
        },
        headStyles: {
          fillColor: [46, 125, 50],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [247, 250, 252]
        }
      });
      
      if(data.length > 0) {
        const totalEntrenos = dadosFiltrados.reduce((sum, reg) => sum + reg.entrenos, 0);
        const totalBrocado = dadosFiltrados.reduce((sum, reg) => sum + reg.brocado, 0);
        const totalBrocamento = (totalBrocado / totalEntrenos * 100).toFixed(2).replace('.', ',');
        
        doc.autoTable({
          body: [
            [
              {content: 'TOTAL GERAL', styles: {fontStyle: 'bold', halign: 'right'}},
              '',
              '',
              {content: totalEntrenos, styles: {fontStyle: 'bold'}},
              {content: totalBrocado, styles: {fontStyle: 'bold'}},
              {content: totalBrocamento + '%', styles: {fontStyle: 'bold'}}
            ]
          ],
          startY: doc.lastAutoTable.finalY + 5,
          styles: {
            fontSize: 10,
            cellPadding: 3,
            halign: 'center'
          }
        });
      }
      
      const date = new Date().toLocaleDateString('pt-BR');
      doc.setFontSize(10);
      doc.text(`Relatório gerado em: ${date}`, 14, doc.lastAutoTable.finalY + 10);
      doc.text(`Total de registros: ${dadosFiltrados.length}`, 14, doc.lastAutoTable.finalY + 15);
      
      doc.save('relatorio_brocamento.pdf');
      showAlert('Relatório PDF gerado com sucesso!');
    }

    function gerarRelatorioPerdaPDF() {
      if(!currentUser.permissions.exportar) {
        showAlert("Você não tem permissão para exportar relatórios", "error");
        return;
      }
      
      const tipoRelatorio = document.getElementById('tipoRelatorioPerda').value;
      
      if(tipoRelatorio === 'A') {
        gerarRelatorioPerdaModeloA();
      } else {
        gerarRelatorioPerdaModeloB();
      }
    }

    function gerarRelatorioPerdaModeloA() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('Relatório de Perda de Cana (Modelo A - Resumido)', 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      const fazendaFiltro = document.getElementById('fazendaFiltroPerda').value;
      const talhaoFiltro = document.getElementById('talhaoFiltroPerda').value;
      const turnoFiltro = document.getElementById('turnoFiltroPerda').value;
      const frenteFiltro = document.getElementById('frenteFiltroPerda').value;
      const inicio = document.getElementById('inicioPerda').value;
      const fim = document.getElementById('fimPerda').value;
      
      let filtros = 'Filtros: ';
      if(fazendaFiltro) filtros += `Fazenda: ${fazendas[fazendaFiltro] || fazendaFiltro} `;
      if(talhaoFiltro) filtros += `Talhão: ${talhaoFiltro} `;
      if(turnoFiltro) filtros += `Turno: ${turnoFiltro} `;
      if(frenteFiltro) filtros += `Frente: ${frenteFiltro} `;
      if(inicio) filtros += `De: ${inicio} `;
      if(fim) filtros += `Até: ${fim}`;
      
      doc.text(filtros, 14, 25);
      
      const headers = [['Fazenda', 'Talhão', 'Data', 'Frente', 'Turno', 'Total', 'Média']];
      
      let dadosFiltrados = [...perdas];
      
      if(fazendaFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.codigo === fazendaFiltro);
      }
      
      if(talhaoFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.talhao.includes(talhaoFiltro));
      }
      
      if(turnoFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.turno === turnoFiltro);
      }
      
      if(frenteFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.frenteServico.includes(frenteFiltro));
      }
      
      if(inicio) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.data >= inicio);
      }
      
      if(fim) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.data <= fim);
      }
      
      const data = dadosFiltrados.map(perda => [
        perda.fazenda,
        perda.talhao,
        perda.data,
        perda.frenteServico,
        perda.turno,
        perda.total,
        perda.media
      ]);
      
      doc.autoTable({
        head: headers,
        body: data,
        startY: 30,
        styles: {
          fontSize: 10,
          cellPadding: 3,
          halign: 'center'
        },
        headStyles: {
          fillColor: [46, 125, 50],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [247, 250, 252]
        }
      });
      
      const date = new Date().toLocaleDateString('pt-BR');
      doc.setFontSize(10);
      doc.text(`Relatório gerado em: ${date}`, 14, doc.lastAutoTable.finalY + 10);
      doc.text(`Total de registros: ${dadosFiltrados.length}`, 14, doc.lastAutoTable.finalY + 15);
      
      doc.save('relatorio_perda.pdf');
      showAlert('Relatório PDF (Modelo A) gerado com sucesso!');
    }

    function gerarRelatorioPerdaModeloB() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('Relatório de Perda de Cana (Modelo B - Detalhado)', 105, 15, { align: 'center' });
      
      doc.setFontSize(12);
      const fazendaFiltro = document.getElementById('fazendaFiltroPerda').value;
      const talhaoFiltro = document.getElementById('talhaoFiltroPerda').value;
      const turnoFiltro = document.getElementById('turnoFiltroPerda').value;
      const frenteFiltro = document.getElementById('frenteFiltroPerda').value;
      const inicio = document.getElementById('inicioPerda').value;
      const fim = document.getElementById('fimPerda').value;
      
      let filtros = 'Filtros: ';
      if(fazendaFiltro) filtros += `Fazenda: ${fazendas[fazendaFiltro] || fazendaFiltro} `;
      if(talhaoFiltro) filtros += `Talhão: ${talhaoFiltro} `;
      if(turnoFiltro) filtros += `Turno: ${turnoFiltro} `;
      if(frenteFiltro) filtros += `Frente: ${frenteFiltro} `;
      if(inicio) filtros += `De: ${inicio} `;
      if(fim) filtros += `Até: ${fim}`;
      
      doc.text(filtros, 14, 25);
      
      // Dados detalhados por linha
      const headers = [
        ['Fazenda', 'Talhão', 'Data', 'Frente', 'Turno', 
         'Cana Inteira', 'Tolete', 'Toco', 'Ponta', 'Estilhaco', 'Pedaço', 'Total', 'Média']
      ];
      
      let dadosFiltrados = [...perdas];
      
      // Aplicar filtros
      if(fazendaFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.codigo === fazendaFiltro);
      }
      
      if(talhaoFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.talhao.includes(talhaoFiltro));
      }
      
      if(turnoFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.turno === turnoFiltro);
      }
      
      if(frenteFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.frenteServico.includes(frenteFiltro));
      }
      
      if(inicio) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.data >= inicio);
      }
      
      if(fim) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.data <= fim);
      }
      
      // Adicionar linhas com todos os dados
      const data = dadosFiltrados.map(perda => [
        perda.fazenda,
        perda.talhao,
        perda.data,
        perda.frenteServico,
        perda.turno,
        perda.canaInteira,
        perda.tolete,
        perda.toco,
        perda.ponta,
        perda.estilhaco,
        perda.pedaco,
        perda.total,
        perda.media
      ]);
      
      doc.autoTable({
        head: headers,
        body: data,
        startY: 30,
        styles: {
          fontSize: 8, // Tamanho menor para caber mais colunas
          cellPadding: 2,
          halign: 'center'
        },
        headStyles: {
          fillColor: [46, 125, 50],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [247, 250, 252]
        }
      });
      
      // Adicionar totais por tipo de perda
      const tipos = ['canaInteira', 'tolete', 'toco', 'ponta', 'estilhaco', 'pedaco'];
      const labels = ['Cana Inteira', 'Tolete', 'Toco', 'Ponta', 'Estilhaço', 'Pedaço'];
      const totais = tipos.map(tipo => 
        dadosFiltrados.reduce((sum, perda) => sum + perda[tipo], 0)
      );
      
      const maxIndex = totais.indexOf(Math.max(...totais));
      const maiorPerda = labels[maxIndex];
      
      const totalGeral = dadosFiltrados.reduce((sum, perda) => sum + perda.total, 0);
      const mediaGeral = totalGeral / dadosFiltrados.length || 0;
      
      // Tabela de totais por tipo
      const totalHeaders = [['Tipo de Perda', 'Total']];
      const totalData = tipos.map((tipo, i) => [labels[i], totais[i]]);
      
      doc.autoTable({
        head: totalHeaders,
        body: totalData,
        startY: doc.lastAutoTable.finalY + 10,
        styles: {
          fontSize: 10,
          cellPadding: 3,
          halign: 'center'
        },
        headStyles: {
          fillColor: [46, 125, 50],
          textColor: 255,
          fontStyle: 'bold'
        }
      });
      
      // Adicionar resumo estatístico
      doc.setFontSize(12);
      doc.text(`Total geral de perdas: ${totalGeral.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
      doc.text(`Média geral de perdas: ${mediaGeral.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 15);
      doc.text(`Tipo com maior perda: ${maiorPerda} (${totais[maxIndex]})`, 14, doc.lastAutoTable.finalY + 20);
      
      const date = new Date().toLocaleDateString('pt-BR');
      doc.setFontSize(10);
      doc.text(`Relatório gerado em: ${date}`, 14, doc.lastAutoTable.finalY + 25);
      doc.text(`Total de registros: ${dadosFiltrados.length}`, 14, doc.lastAutoTable.finalY + 30);
      
      doc.save('relatorio_perda_detalhado.pdf');
      showAlert('Relatório PDF (Modelo B - Detalhado) gerado com sucesso!');
    }

    function exportarBrocamentoExcel() {
      if(!currentUser.permissions.exportar) {
        showAlert("Você não tem permissão para exportar relatórios", "error");
        return;
      }
      
      let csv = 'Fazenda,Talhão,Data,Entrenós,Brocado,Brocamento (%)\n';
      
      const fazendaFiltro = document.getElementById('fazendaFiltroBrocamento').value;
      const inicio = document.getElementById('inicioBrocamento').value;
      const fim = document.getElementById('fimBrocamento').value;
      
      let dadosFiltrados = [...registros];
      
      if(fazendaFiltro) {
        dadosFiltrados = dadosFiltrados.filter(reg => reg.codigo === fazendaFiltro);
      }
      
      if(inicio) {
        dadosFiltrados = dadosFiltrados.filter(reg => reg.data >= inicio);
      }
      
      if(fim) {
        dadosFiltrados = dadosFiltrados.filter(reg => reg.data <= fim);
      }
      
      dadosFiltrados.forEach(reg => {
        csv += `"${reg.fazenda}","${reg.talhao}","${reg.data}",${reg.entrenos},${reg.brocado},${reg.brocamento}\n`;
      });
      
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', 'relatorio_brocamento.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('Relatório Excel gerado com sucesso!');
    }

    function exportarPerdaExcel() {
      if(!currentUser.permissions.exportar) {
        showAlert("Você não tem permissão para exportar relatórios", "error");
        return;
      }
      
      let csv = 'Fazenda,Talhão,Data,Frente,Turno,Cana Inteira,Tolete,Toco,Ponta,Estilhaco,Pedaco,Total,Média\n';
      
      const fazendaFiltro = document.getElementById('fazendaFiltroPerda').value;
      const talhaoFiltro = document.getElementById('talhaoFiltroPerda').value;
      const turnoFiltro = document.getElementById('turnoFiltroPerda').value;
      const frenteFiltro = document.getElementById('frenteFiltroPerda').value;
      const inicio = document.getElementById('inicioPerda').value;
      const fim = document.getElementById('fimPerda').value;
      
      let dadosFiltrados = [...perdas];
      
      if(fazendaFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.codigo === fazendaFiltro);
      }
      
      if(talhaoFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.talhao.includes(talhaoFiltro));
      }
      
      if(turnoFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.turno === turnoFiltro);
      }
      
      if(frenteFiltro) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.frenteServico.includes(frenteFiltro));
      }
      
      if(inicio) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.data >= inicio);
      }
      
      if(fim) {
        dadosFiltrados = dadosFiltrados.filter(perda => perda.data <= fim);
      }
      
      dadosFiltrados.forEach(perda => {
        csv += `"${perda.fazenda}","${perda.talhao}","${perda.data}","${perda.frenteServico}","${perda.turno}",${perda.canaInteira},${perda.tolete},${perda.toco},${perda.ponta},${perda.estilhaco},${perda.pedaco},${perda.total},${perda.media}\n`;
      });
      
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', 'relatorio_perda.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showAlert('Relatório Excel gerado com sucesso!');
    }

    btnLogin.addEventListener('click', () => {
      const username = loginUser.value.trim();
      const password = loginPass.value;

      if(!username || !password) {
        loginMessage.textContent = "Preencha usuário e senha.";
        loginMessage.style.display = "block";
        return;
      }

      users = JSON.parse(localStorage.getItem('users')) || [];
      
      const user = users.find(u => 
        u.username === username && 
        u.password === password && 
        u.active === true
      );

      if(!user) {
        loginMessage.textContent = "Usuário ou senha inválidos.";
        loginMessage.style.display = "block";
        return;
      }

      currentUser = user;
      
      if(currentUser.username === 'admin' && currentUser.password === 'admin123') {
        showAlert("Por segurança, altere sua senha padrão nas configurações de usuário", "warning");
      }
      
      loginScreen.style.display = "none";
      appScreen.style.display = "flex";
      logoutInfo.style.display = "flex";
      userNameDisplay.textContent = currentUser.username;
      currentDateTime.textContent = formatDateTime();
      
      menu.hidden = false;
      renderMenu();
      
      showTab('dashboard');
      
      renderGraficoBrocamento();
      renderGraficoPerda();
      renderExclusao();
      renderUsersList();
      
      setInterval(updateDateTime, 60000);
    });

    loginPass.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') {
        btnLogin.click();
      }
    });

    logoutBtn.addEventListener('click', () => {
      currentUser = null;
      loginScreen.style.display = "flex";
      appScreen.style.display = "none";
      menu.hidden = true;
      logoutInfo.style.display = "none";
      loginUser.focus();
      closeAllMenus();
      hideAllTabs();
    });

    btnToggleMenu.addEventListener('click', () => {
      const aberto = btnToggleMenu.classList.toggle('open');
      menu.classList.toggle('open');
      btnToggleMenu.setAttribute('aria-expanded', aberto);
      
      if (aberto) {
        content.classList.add('menu-open');
        menu.style.visibility = 'visible';
      } else {
        content.classList.remove('menu-open');
        menu.style.visibility = 'hidden';
        closeAllMenus();
      }
    });

    document.addEventListener('click', e => {
      const isMenuClick = menu.contains(e.target) || 
                     e.target === btnToggleMenu || 
                     (document.querySelector('nav.submenu.open')?.contains(e.target));
      
      if(!isMenuClick) {
        closeAllMenus();
        btnToggleMenu.classList.remove('open');
        menu.classList.remove('open');
        content.classList.remove('menu-open');
      }
    });

    document.getElementById('codigo').addEventListener('input', () => updateFazendaNome('codigo', 'fazendaNome'));
    document.getElementById('codigoPerda').addEventListener('input', () => updateFazendaNome('codigoPerda', 'fazendaNomePerda'));

    ['entrenos', 'brocado'].forEach(id => document.getElementById(id).addEventListener('input', calcularPorcentagemBrocamento));

    ['canaInteira', 'tolete', 'toco', 'ponta', 'estilhaco', 'pedaco'].forEach(id => document.getElementById(id).addEventListener('input', calcularSomaPerda));

    document.getElementById('btnSalvarBrocamento').addEventListener('click', salvarBrocamento);
    document.getElementById('btnSalvarPerda').addEventListener('click', salvarPerda);

    document.getElementById('btnPDFBrocamento').addEventListener('click', gerarRelatorioBrocamentoPDF);
    document.getElementById('btnExcelBrocamento').addEventListener('click', exportarBrocamentoExcel);

    document.getElementById('btnPDFPerda').addEventListener('click', gerarRelatorioPerdaPDF);
    document.getElementById('btnExcelPerda').addEventListener('click', exportarPerdaExcel);

    newUserRole.addEventListener('change', function() {
      const role = this.value;
      
      switch(role) {
        case 'admin':
          permDashboard.checked = true;
          permLancamento.checked = true;
          permLancamentoPerda.checked = true;
          permRelatorio.checked = true;
          permExcluir.checked = true;
          permGerenciarUsuarios.checked = true;
          permConfiguracoes.checked = true;
          permExportar.checked = true;
          permVisualizar.checked = true;
          permEditar.checked = true;
          break;
        case 'supervisor':
          permDashboard.checked = true;
          permLancamento.checked = false;
          permLancamentoPerda.checked = false;
          permRelatorio.checked = false;
          permExcluir.checked = false;
          permGerenciarUsuarios.checked = false;
          permConfiguracoes.checked = false;
          permExportar.checked = false;
          permVisualizar.checked = true;
          permEditar.checked = false;
          break;
        case 'tecnico':
          permDashboard.checked = true;
          permLancamento.checked = false;
          permLancamentoPerda.checked = false;
          permRelatorio.checked = false;
          permExcluir.checked = false;
          permGerenciarUsuarios.checked = false;
          permConfiguracoes.checked = false;
          permExportar.checked = false;
          permVisualizar.checked = true;
          permEditar.checked = false;
          break;
        case 'colaborador':
          permDashboard.checked = true;
          permLancamento.checked = false;
          permLancamentoPerda.checked = false;
          permRelatorio.checked = false;
          permExcluir.checked = false;
          permGerenciarUsuarios.checked = false;
          permConfiguracoes.checked = false;
          permExportar.checked = false;
          permVisualizar.checked = true;
          permEditar.checked = false;
          break;
        default:
          break;
      }
    });

    btnCreateUser.addEventListener('click', () => {
      const username = newUserUsername.value.trim();
      const password = newUserPassword.value;
      
      if(!username || !password) {
        showAlert("Preencha usuário e senha para criar novo usuário.", "error");
        return;
      }
      
      if(users.some(u => u.username === username)) {
        showAlert("Usuário já existe.", "error");
        return;
      }
      
      const permissions = {
        dashboard: permDashboard.checked,
        lancamentoBroca: permLancamento.checked,
        lancamentoPerda: permLancamentoPerda.checked,
        relatorio: permRelatorio.checked,
        excluir: permExcluir.checked,
        gerenciarUsuarios: permGerenciarUsuarios.checked,
        configuracoes: permConfiguracoes.checked,
        exportar: permExportar.checked,
        visualizar: permVisualizar.checked,
        editar: permEditar.checked
      };
      
      const novoUser = {
        username,
        password,
        role: newUserRole.value,
        active: true,
        permissions
      };
      
      users.push(novoUser);
      saveUsers();
      renderUsersList();
      showAlert(`Usuário ${username} criado com sucesso.`);
      
      newUserUsername.value = '';
      newUserPassword.value = '';
      newUserRole.value = 'user';
      
      permDashboard.checked = true;
      permLancamento.checked = false;
      permLancamentoPerda.checked = false;
      permRelatorio.checked = false;
      permExcluir.checked = false;
      permGerenciarUsuarios.checked = false;
      permConfiguracoes.checked = false;
      permExportar.checked = false;
      permVisualizar.checked = true;
      permEditar.checked = false;
    });

    document.addEventListener('keydown', e => {
      if(e.key === 'Enter') {
        const formElements = Array.from(document.querySelectorAll('input, select, textarea, button')).filter(el => el.offsetParent !== null);
        const index = formElements.indexOf(document.activeElement);
        if(index > -1 && index < formElements.length -1) {
          e.preventDefault();
          formElements[index+1].focus();
        }
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      loginUser.focus();
    });
  </script>
</body>
</html>
